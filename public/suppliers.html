<script>
  async function findSuppliers() {
    const mat  = document.getElementById('material').value;
    const lead = document.getElementById('lead').value;
    const esg  = document.getElementById('esg').value;

    const url = `/api/find_suppliers?material_category=${encodeURIComponent(mat)}`
      + (lead ? `&max_lead_days=${encodeURIComponent(lead)}` : '')
      + (esg  ? `&min_esg=${encodeURIComponent(esg)}` : '');

    const tbody = document.querySelector('#results tbody');
    const table = document.getElementById('results');
    tbody.innerHTML = `<tr><td colspan="9">Loading…</td></tr>`;
    table.style.display = 'table';

    try {
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const list = Array.isArray(data) ? data : (data.suppliers || data.results || data.data || []);

      if (!list || !list.length) {
        tbody.innerHTML = `<tr><td colspan="9">No results. Try different filters.</td></tr>`;
        return;
      }

      tbody.innerHTML = '';
      list.forEach(s => {
        const row = `<tr>
          <td>${s.supplier_name ?? s.name ?? '—'}</td>
          <td>${s.city ?? '—'}</td>
          <td>${s.country ?? '—'}</td>
          <td>${s.material_category ?? s.material ?? '—'}</td>
          <td>${s.unit_cost_gbp ?? '—'}</td>
          <td>${s.lead_time_days ?? s.lead_days ?? '—'}</td>
          <td>${s.moq_units ?? s.moq ?? '—'}</td>
          <td>${s.esg_score_0_100 ?? s.esg ?? '—'}</td>
          <td>${Array.isArray(s.certifications) ? s.certifications.join(', ') : (s.certifications ?? '—')}</td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="9">Error: ${err.message}</td></tr>`;
    }
  }
</script>
